# VideoMaker 后端服务启动说明

## 📋 项目概览

VideoMaker 是一个基于 FastAPI 的综合性后端服务，提供以下功能：
- 📄 PDF处理和解析
- 🎤 TTS语音合成
- 🎬 视频转码和处理  
- 🖼️ 图片处理和分析
- 📊 PPT文档处理
- 📋 任务管理系统

## 🛠️ 技术栈

- **Web框架**: FastAPI + Uvicorn
- **AI服务**: OpenAI API
- **视频处理**: FFmpeg
- **图像处理**: OpenCV, PIL
- **文档处理**: PyMuPDF, python-pptx
- **数据库**: MySQL, Redis
- **其他**: SQLAlchemy

## 🚀 快速启动

方式：使用uvicorn
```bash
# 进入后端目录
cd videomaker/backend

# 激活虚拟环境
venv\Scripts\activate

# 直接启动
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

## 📦 环境准备

### 1. Python环境
- Python 3.8+ 
- 虚拟环境已配置在 `venv/` 目录

### 2. 数据库环境
- **MySQL**: 必需
  ```bash
  # 配置MySQL数据库
  cd mysql
  
  # Windows
  setup_database.bat
  
  # Linux/MacOS
  bash setup_database.sh
  
  # 或使用Python脚本
  python setup_database_python.py
  ```

- **Redis**: 必需
  ```bash
  # Windows
  # 下载地址：https://github.com/microsoftarchive/redis/releases
  # 安装后启动Redis服务
  
  # Linux
  sudo apt update && sudo apt install redis-server
  sudo systemctl start redis-server
  
  # MacOS
  brew install redis
  brew services start redis
  ```

### 3. 系统依赖
- **FFmpeg**: 视频处理必需
  ```bash
  # Windows (使用scoop)
  scoop install ffmpeg
  
  # macOS
  brew install ffmpeg
  
  # Ubuntu/Debian
  sudo apt update && sudo apt install ffmpeg
  ```

- **Tesseract OCR**: 文字识别功能
  ```bash
  # Windows
  下载安装包: https://github.com/tesseract-ocr/tesseract
  
  # macOS
  brew install tesseract
  
  # Ubuntu/Debian  
  sudo apt install tesseract-ocr
  ```

## 🔧 依赖安装

```bash
# 激活虚拟环境
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 验证关键依赖
python -c "import fastapi, uvicorn, openai, cv2, ffmpeg, redis, sqlalchemy; print('✅ 依赖检查通过')"
```

## 🌐 服务访问

启动成功后，可以通过以下地址访问：

- **API服务**: http://localhost:8000
- **API文档**: http://localhost:8000/docs
- **ReDoc文档**: http://localhost:8000/redoc
- **健康检查**: http://localhost:8000

## 📚 API模块

### 核心功能模块
- `/api/pdf` - PDF处理相关接口
- `/api/tts` - 语音合成相关接口  
- `/api/videos` - 视频处理和转码接口
- `/api/notes` - 笔记和文档处理接口
- `/api/images` - 图片处理接口
- `/api/tasks` - 任务管理接口
- `/api/downloads` - 文件下载接口

### 🎬 视频制作工作流程

API文档已组织为完整的工作流程，按以下步骤调用即可完成PPT到视频的转换：

1. **上传PPT并转换为PDF** - `/api/pdf/upload-ppt-convert-pdf`
2. **PDF转换为图片** - `/api/pdf/convert/{task_id}`
3. **为图片添加黑色边框** - `/api/image-notes/add-black-border` 
4. **生成文件夹脚本** - `/api/notes/generate-folder-scripts`
5. **生成所有音频** - `/api/tts/generate`

每个API都在文档中有详细说明，包括输入参数、处理流程和返回结果。
各个步骤之间通过task_id关联，确保工作流的连贯性。

## 🗂️ 目录结构

```
videomaker/backend/
├── app/                    # 应用主目录
│   ├── api/               # API路由模块
│   │   ├── pdf_api.py     # PDF处理接口
│   │   ├── video_api.py   # 视频处理接口
│   │   ├── tts_api.py     # TTS接口
│   │   └── ...
│   └── utils/             # 工具模块
│       ├── transcoding.py # 视频转码工具
│       ├── task_manager_memory.py # 任务管理
│       ├── mysql_config_helper.py # MySQL配置
│       └── ...
├── mysql/                 # MySQL数据库配置
│   ├── create_database.sql # 创建数据库脚本
│   ├── init.sql           # 数据初始化脚本
│   ├── setup_database.bat # Windows数据库配置
│   ├── setup_database.sh  # Linux数据库配置
│   └── setup_database_python.py # Python数据库配置
├── main.py                # FastAPI应用主文件
├── start_server.py        # 启动脚本
├── requirements.txt       # Python依赖
├── docker-compose.yml     # Docker配置
├── uploads/               # 上传文件目录
├── videos/                # 视频文件目录
├── encoded_videos/        # 转码输出目录
├── notes_output/          # 笔记输出目录
└── ...
```

## 📋 启动检查清单

启动前请确认：

- [ ] Python 3.10+ 已安装
- [ ] 虚拟环境已激活
- [ ] MySQL服务已启动且数据库已创建
- [ ] Redis服务已启动
- [ ] FFmpeg 已安装并在PATH中
- [ ] 所有依赖已安装 (`pip install -r requirements.txt`)
- [ ] 端口8000未被占用
- [ ] 相关目录有读写权限

## 🔍 常见问题

### 1. FFmpeg未找到
```bash
# 检查FFmpeg是否安装
ffmpeg -version

# 如果未安装，参考上面的安装说明
```

### 2. 端口被占用
```bash
# 查看占用端口的进程
netstat -ano | findstr :8000

# 杀死占用进程（Windows）
taskkill /PID <进程ID> /F

# 或者修改端口
uvicorn main:app --port 8001
```

### 3. 依赖安装失败
```bash
# 更新pip
python -m pip install --upgrade pip

# 清理缓存重新安装
pip cache purge
pip install -r requirements.txt --no-cache-dir
```

### 4. OpenAI API配置
确保 `.env` 文件中的 `OPENAI_API_KEY` 配置正确。

### 5. MySQL连接问题
```bash
# 检查MySQL服务是否运行
# Windows
sc query mysql

# Linux
systemctl status mysql

# 验证数据库是否创建
mysql -u root -p -e "SHOW DATABASES;"
```

### 6. Redis连接问题
```bash
# 检查Redis服务状态
# Windows
sc query redis

# Linux
systemctl status redis-server

# 测试Redis连接
redis-cli ping
```

## 📊 服务监控

### 日志查看
- 控制台日志：实时显示在终端
- 转码日志：查看 `transcoding.log` 文件

### 健康检查
```bash
# API健康检查
curl http://localhost:8000

# 具体功能测试
curl http://localhost:8000/api/videos/all-folders
```

## 🔧 开发模式

```bash
# 开启热重载模式
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# 开启调试模式
uvicorn main:app --reload --log-level debug
```

## 🛑 停止服务

- **快捷键**: Ctrl + C
- **Docker**: `docker stop <container_id>`

---

**📞 需要帮助？**
- 查看API文档: http://localhost:8000/docs
- 检查日志输出获取详细错误信息
- 确认所有依赖和环境配置正确

---
*最后更新: 2024年3月15日* 